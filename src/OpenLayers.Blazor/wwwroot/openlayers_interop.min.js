export function MapOLInit(mapId,popupId,options,center,zoom,rotation,interactions,layers,instance,configureJsMethod){try{if(!mapId||!instance){console.error("MapOLInit: mapId and instance are required");return}_MapOL[mapId]=new MapOL(mapId,popupId,options,center,zoom,rotation,interactions,layers,instance,configureJsMethod)}catch(error){console.error("MapOLInit failed:",error)}}export function MapOLDispose(mapId){try{_MapOL[mapId]&&(_MapOL[mapId].dispose&&_MapOL[mapId].dispose(),_MapOL[mapId]=undefined)}catch(error){console.error("MapOLDispose failed:",error)}}export function MapOLCenter(mapId,point){try{_MapOL[mapId]&&point&&_MapOL[mapId].setCenter(point)}catch(error){console.error("MapOLCenter failed:",error)}}export function MapOLRotate(mapId,rotation){try{_MapOL[mapId]&&typeof rotation=="number"&&_MapOL[mapId].setRotation(rotation)}catch(error){console.error("MapOLRotate failed:",error)}}export function MapOLZoom(mapId,zoom){try{_MapOL[mapId]&&typeof zoom=="number"&&_MapOL[mapId].setZoom(zoom)}catch(error){console.error("MapOLZoom failed:",error)}}export function MapOLSetOptions(mapId,options){try{_MapOL[mapId]&&options&&_MapOL[mapId].setOptions(options)}catch(error){console.error("MapOLSetOptions failed:",error)}}export function MapOLZoomToExtent(mapId,layerId,padding){try{_MapOL[mapId]&&_MapOL[mapId].setZoomToExtent(layerId,padding)}catch(error){console.error("MapOLZoomToExtent failed:",error)}}export function MapOLCenterToCurrentGeoLocation(mapId){try{_MapOL[mapId]&&_MapOL[mapId].centerToCurrentGeoLocation()}catch(error){console.error("MapOLCenterToCurrentGeoLocation failed:",error)}}export function MapOLGetCurrentGeoLocation(mapId){try{return _MapOL[mapId]?_MapOL[mapId].getCurrentGeoLocation():Promise.reject("Map not found")}catch(error){return console.error("MapOLGetCurrentGeoLocation failed:",error),Promise.reject(error)}}export function MapOLSetLayers(mapId,layers){try{_MapOL[mapId]&&Array.isArray(layers)&&_MapOL[mapId].setLayers(layers)}catch(error){console.error("MapOLSetLayers failed:",error)}}export function MapOLRemoveLayer(mapId,layerId){try{_MapOL[mapId]&&layerId&&_MapOL[mapId].removeLayer(layerId)}catch(error){console.error("MapOLRemoveLayer failed:",error)}}export function MapOLAddLayer(mapId,layer){try{_MapOL[mapId]&&layer&&_MapOL[mapId].addLayer(layer)}catch(error){console.error("MapOLAddLayer failed:",error)}}export function MapOLUpdateLayer(mapId,layer){try{_MapOL[mapId]&&layer&&_MapOL[mapId].updateLayer(layer)}catch(error){console.error("MapOLUpdateLayer failed:",error)}}export function MapOLSetVisibleExtent(mapId,extent){try{_MapOL[mapId]&&extent&&_MapOL[mapId].setVisibleExtent(extent)}catch(error){console.error("MapOLSetVisibleExtent failed:",error)}}export function MapOLSetDrawingSettings(mapId,drawingLayerId,enableNewShapes,enableEditShapes,enableShapeSnap,geometryType,freehand){try{_MapOL[mapId]&&_MapOL[mapId].setDrawingSettings(drawingLayerId,enableNewShapes,enableEditShapes,enableShapeSnap,geometryType,freehand)}catch(error){console.error("MapOLSetDrawingSettings failed:",error)}}export function MapOLUndoDrawing(mapId){try{_MapOL[mapId]&&_MapOL[mapId].undoDrawing()}catch(error){console.error("MapOLUndoDrawing failed:",error)}}export function MapOLUpdateShape(mapId,layerId,shape){try{_MapOL[mapId]&&layerId&&shape&&_MapOL[mapId].updateShape(layerId,shape)}catch(error){console.error("MapOLUpdateShape failed:",error)}}export function MapOLSetShapes(mapId,layerId,shapes){try{_MapOL[mapId]&&layerId&&_MapOL[mapId].setShapes(layerId,shapes)}catch(error){console.error("MapOLSetShapes failed:",error)}}export function MapOLRemoveShape(mapId,layerId,shape){try{_MapOL[mapId]&&layerId&&shape&&_MapOL[mapId].removeShapes(layerId,shape)}catch(error){console.error("MapOLRemoveShape failed:",error)}}export function MapOLAddShape(mapId,layerId,shapes){try{_MapOL[mapId]&&layerId&&_MapOL[mapId].addShapes(layerId,shapes)}catch(error){console.error("MapOLAddShape failed:",error)}}export function MapOLGetCoordinates(mapId,layerId,shapeId){try{return _MapOL[mapId]&&layerId&&shapeId?_MapOL[mapId].getCoordinates(layerId,shapeId):null}catch(error){return console.error("MapOLGetCoordinates failed:",error),null}}export function MapOLSetCoordinates(mapId,layerId,shapeId,coordinates){try{if(_MapOL[mapId]&&layerId&&shapeId&&coordinates)return _MapOL[mapId].setCoordinates(layerId,shapeId,coordinates)}catch(error){console.error("MapOLSetCoordinates failed:",error)}}export function MapOLSetInteractions(mapId,active){try{_MapOL[mapId]&&typeof active=="boolean"&&_MapOL[mapId].setInteractions(active)}catch(error){console.error("MapOLSetInteractions failed:",error)}}export function MapOLSetSelectionSettings(mapId,layerId,selectionEnabled,selectionStyle,multiSelect){try{_MapOL[mapId]&&layerId&&_MapOL[mapId].setSelectionSettings(layerId,selectionEnabled,selectionStyle,multiSelect)}catch(error){console.error("MapOLSetSelectionSettings failed:",error)}}export function MapOLShowPopup(mapId,coordinates){try{_MapOL[mapId]&&coordinates&&_MapOL[mapId].showPopup(coordinates)}catch(error){console.error("MapOLShowPopup failed:",error)}}export function MapOLApplyMapboxStyle(mapId,styleUrl,accessToken){try{_MapOL[mapId]&&styleUrl&&_MapOL[mapId].applyMapboxStyle(styleUrl,accessToken)}catch(error){console.error("MapOLApplyMapboxStyle failed:",error)}}function MapOL(mapId,popupId,options,center,zoom,rotation,interactions,layers,instance,configureJsMethod){this.Instance=instance;this.Options=options||{};const projectionLV03=new ol.proj.Projection({code:"EPSG:21781",extent:[485869.5728,76443.1884,837076.5648,299941.7864],units:"m"});ol.proj.addProjection(projectionLV03);const projectionLV95=new ol.proj.Projection({code:"EPSG:2056",extent:[2485071.58,1074261.72,2837119.8,1299941.79],units:"m"});ol.proj.addProjection(projectionLV95);ol.proj.addCoordinateTransforms("EPSG:4326",projectionLV03,coordinate=>[MapOL.WGStoLV03y(coordinate[1],coordinate[0]),MapOL.WGStoLV03x(coordinate[1],coordinate[0])],coordinate=>[MapOL.CHtoLV03lng(coordinate[0],coordinate[1]),MapOL.CHtoLV03lat(coordinate[0],coordinate[1])]);ol.proj.addCoordinateTransforms("EPSG:4326",projectionLV95,coordinate=>[MapOL.WGStoLV95y(coordinate[1],coordinate[0]),MapOL.WGStoLV95x(coordinate[1],coordinate[0])],coordinate=>[MapOL.LV95toWGSlng(coordinate[0],coordinate[1]),MapOL.LV95toWGSlat(coordinate[0],coordinate[1])]);this.Options.coordinatesProjection||(this.Options.coordinatesProjection="EPSG:4326");const ollayers=this.prepareLayers(layers||[]);let viewProjection=ollayers.length>0?ollayers[0].getSource().getProjection():undefined,viewExtent=ollayers.length>0?ollayers[0].getExtent():undefined,viewCenter=center||undefined;this.Options.viewProjection?viewProjection=this.Options.viewProjection:viewProjection||(viewProjection=this.Options.coordinatesProjection=="EPSG:2056"?projectionLV95:this.Options.coordinatesProjection=="EPSG:21781"?projectionLV03:"EPSG:3857");viewCenter&&(viewCenter=ol.proj.transform(viewCenter,this.Options.coordinatesProjection,viewProjection));this.Map=new ol.Map({layers:ollayers,target:mapId,controls:[],view:new ol.View({projection:viewProjection,center:viewCenter,extent:viewExtent,zoom:zoom,rotation:rotation,maxZoom:this.Options.maxZoom,minZoom:this.Options.minZoom}),interactions:ol.interaction.defaults.defaults().extend([new ol.interaction.DragRotateAndZoom])});this.addControls();const that=this,popupElement=document.getElementById(popupId);if(this.OverlayPopup=new ol.Overlay({element:popupElement,positioning:"bottom-center",stopEvent:!this.Options.popupAllowMapEvents,offset:this.Options.popupOffset}),this.Map.addOverlay(this.OverlayPopup),this.setInteractions(interactions),this.setSelectionSettings(!0),configureJsMethod)try{const namespaces=configureJsMethod.split("."),func=namespaces.pop();let context=window;for(let i=0;i<namespaces.length;i++)context=context[namespaces[i]];context[func].apply(context,[this.Map])}catch(err){console.error("ConfigureJsMethod failed:",err)}this._eventHandlers={click:evt=>that.onMapClick(evt,that.OverlayPopup,popupElement),dblclick:evt=>that.onMapDblClick(evt),pointermove:evt=>that.onMapPointerMove(evt),rendercomplete:()=>that.Instance.invokeMethodAsync("OnInternalRenderComplete"),viewResolution:()=>that.onMapResolutionChanged(),viewCenter:()=>that.onMapCenterChanged(),viewRotation:()=>that.onMapRotationChanged()};this.Map.on("click",this._eventHandlers.click);this.Map.on("dblclick",this._eventHandlers.dblclick);this.Map.on("pointermove",this._eventHandlers.pointermove);this.Map.on("rendercomplete",this._eventHandlers.rendercomplete);this.Map.getView().on("change:resolution",this._eventHandlers.viewResolution);this.Map.getView().on("change:center",this._eventHandlers.viewCenter);this.Map.getView().on("change:rotation",this._eventHandlers.viewRotation);this.onMapCenterChanged()}const _MapOL=[];MapOL.prototype.dispose=function(){try{if(this.Map&&this._eventHandlers){this.Map.un("click",this._eventHandlers.click);this.Map.un("dblclick",this._eventHandlers.dblclick);this.Map.un("pointermove",this._eventHandlers.pointermove);this.Map.un("rendercomplete",this._eventHandlers.rendercomplete);const view=this.Map.getView();view&&(view.un("change:resolution",this._eventHandlers.viewResolution),view.un("change:center",this._eventHandlers.viewCenter),view.un("change:rotation",this._eventHandlers.viewRotation))}this.Map&&(this.Map.setTarget(null),this.Map=null);this.Instance=null;this.Options=null;this.OverlayPopup=null;this._eventHandlers=null}catch(error){console.error("MapOL dispose failed:",error)}};MapOL.prototype.prepareLayers=function(layers){const ollayers=[],that=this;return layers.forEach(l=>{var layer,features,defaultStyle;try{let source,sourceType=l.source.sourceType;if(l.options&&(l=Object.assign(l,l.options),delete l.options),l.source&&l.source.options&&(l.source=Object.assign(l.source,l.source.options),delete l.source.options),l=MapOL.transformNullToUndefined(l),l.extent&&this.Options.coordinatesProjection){let projection=that.Options.viewProjection?that.Options.viewProjection:ollayers.length>0?ollayers[0].getSource().getProjection():"EPSG:3857";l.extent=ol.proj.transformExtent(l.extent,l.source.projection?l.source.projection:that.Options.coordinatesProjection,projection)}switch(sourceType){case"TileImage":source=new ol.source.TileImage(l.source);break;case"BingMaps":source=new ol.source.BingMaps(l.source);break;case"OGCMapTile":source=new ol.source.OGCMapTile(l.source);break;case"TileArcGISRest":source=new ol.source.TileArcGISRest(l.source);break;case"TileJSON":source=new ol.source.TileJSON(l.source);break;case"TileWMS":source=new ol.source.TileWMS(l.source);break;case"WMTS":source=new ol.source.WMTS(l.source);break;case"Zoomify":source=new ol.source.Zoomify(l.source);break;case"OSM":source=new ol.source.OSM(l.source);break;case"XYZ":source=new ol.source.XYZ(l.source);break;case"CartoDB":source=new ol.source.CartoDB(l.source);break;case"Stamen":source=new ol.source.Stamen(l.source);break;case"StadiaMaps":source=new ol.source.StadiaMaps(l.source);break;case"TileDebug":source=new ol.source.TileDebug(l.source);break;case"VectorKML":l.source.format=new ol.format.KML(l.source.formatOptions);break;case"VectorEsriJson":l.source.format=new ol.format.EsriJSON(l.source.formatOptions);break;case"VectorGeoJson":l.source.format=new ol.format.GeoJSON(l.source.formatOptions);break;case"VectorTopoJson":l.source.format=new ol.format.TopoJson(l.source.formatOptions);break;case"VectorMVT":l.source.format=new ol.format.MVT(l.source.formatOptions);break;case"VectorIGC":l.source.format=new ol.format.IGC(l.source.formatOptions);break;case"VectorPolyline":l.source.format=new ol.format.Polyline(l.source.formatOptions);break;case"VectorWKT":l.source.format=new ol.format.WKT(l.source.formatOptions);break;case"VectorWKB":l.source.format=new ol.format.WKB(l.source.formatOptions);break;case"VectorGML2":l.source.format=new ol.format.GML2(l.source.formatOptions);break;case"VectorGML3":l.source.format=new ol.format.GML3(l.source.formatOptions);break;case"VectorGPX":l.source.format=new ol.format.GPX(l.source.formatOptions);break;case"VectorOSMXML":l.source.format=new ol.format.OSMXML(s);break;case"VectorWFS":l.source.format=new ol.format.WFS(l.source.formatOptions);break;case"ImageArcGISRest":source=new ol.source.ImageArcGISRest(l.source);break;case"ImageCanvasSource":source=new ol.source.ImageCanvasSource(l.source);break;case"ImageMapGuide":source=new ol.source.ImageMapGuide(l.source);break;case"ImageStatic":l.extent&&!l.source.imageExtent&&(l.source.imageExtent=l.extent);source=new ol.source.ImageStatic(l.source);break;case"ImageWMS":source=new ol.source.ImageWMS(l.source)}switch(l.layerType){case"Image":l.source=source;layer=new ol.layer.Image(l);break;case"Vector":case"VectorTile":case"VectorCluster":if(l.useStyleCallback?l.style=function(feature){that.getShapeStyleAsync(feature,l.id).then(style=>feature.setStyle(style))}:l.style?l.style=that.mapStyleOptionsToStyle(l.style):l.flatStyle&&(l.style=l.flatStyle),l.source.data&&(features=l.source.format.readFeatures(l.source.data,{featureProjection:this.Options.viewProjection?this.Options.viewProjection:ollayers.length>0?ollayers[0].getSource().getProjection():that.Map?that.Map.getView().getProjection():"EPSG:3857",dataProjection:l.source.projection?l.source.projection:this.Options.coordinatesProjection})),l.source=l.layerType=="VectorTile"?new ol.source.VectorTile(l.source):new ol.source.Vector(l.source),l.raiseShapeEvents){l.source.on("addfeature",function(evt){that.onFeatureAdded(l.id,evt.feature)});l.source.on("changefeature",function(evt){that.onFeatureChanged(l.id,evt.feature)});l.source.on("removefeature",function(evt){that.onFeatureRemoved(l.id,evt.feature)})}features&&l.source.addFeatures(features);const styleCache={};l.layerType=="VectorCluster"&&(defaultStyle=l.style,l.source=new ol.source.Cluster({distance:l.clusterDistance!=null?l.clusterDistance:50,minDistance:0,source:l.source}),l.style=function(feature){const size=feature.get("features").length;if(size>1){let style=styleCache[size];if(!style){if(defaultStyle){typeof defaultStyle=="function"&&(style=defaultStyle(feature,that.Map.getView().getResolution()));defaultStyle.clone&&(style=defaultStyle.clone());let txt=style.getText();txt&&txt.getText()==null&&txt.setText(size.toString());let img=style.getImage();img&&img.setRadius&&size>3&&img.setRadius(5*size)}else style=new ol.style.Style({image:new ol.style.Circle({radius:size>3?5*size:10,stroke:new ol.style.Stroke({color:"#fff",width:1}),fill:new ol.style.Fill({color:"#3399CC"})}),text:new ol.style.Text({text:size.toString(),fill:new ol.style.Fill({color:"#fff"})})});styleCache[size]=style}return style}const originalFeature=feature.get("features")[0];return originalFeature.getStyle()});layer=l.layerType=="VectorTile"?new ol.layer.VectorTile(l):new ol.layer.Vector(l);break;case"Heatmap":l.source=new ol.source.Vector(l.source);layer=new ol.layer.Heatmap(l);break;case"Graticule":l.showLabels==undefined&&(l.showLabels=!0);l.wrapX==undefined&&(l.wrapX=!1);delete l.source;layer=new ol.layer.Graticule(l);break;case"VectorImage":l.source=new ol.source.Vector(l.source);layer=new ol.layer.VectorImage(l);break;case"WebGLTile":l.source=source;layer=new ol.layer.WebGLTile(l);break;case"MapboxVectorStyle":l.styleUrl=l.source.url;l.source=l.source.layer;layer=new olms.MapboxVectorLayer(l);break;default:l.source=source;layer=new ol.layer.Tile(l)}ollayers.push(layer)}catch(exp){console.error(`Could no add layer: ${exp}`)}}),ollayers};MapOL.prototype.getLayer=function(layerId){return this.Map.getAllLayers().find(l=>l.get("id")==layerId)};MapOL.prototype.setLayers=function(layers){this.Map.setLayers(this.prepareLayers(layers))};MapOL.prototype.removeLayer=function(layerId){this.Map.removeLayer(this.getLayer(layerId))};MapOL.prototype.addLayer=function(layer){const ollayers=this.prepareLayers([layer]);this.Map.addLayer(ollayers[0])};MapOL.prototype.updateLayer=function(layer){const olayer=this.Map.getAllLayers().find(l=>l.get("id")==layer.id);olayer!=undefined&&(olayer.setVisible(layer.visibility),olayer.setOpacity(layer.opacity),olayer.setZIndex(layer.zIndex),olayer.setExtent(layer.extent))};MapOL.prototype.getShapesLayer=function(){return this.getLayer("shapes")};MapOL.prototype.getMarkersLayer=function(){return this.getLayer("markers")};MapOL.prototype.setZoom=function(zoom){this.Map.getView().setZoom(zoom)};MapOL.prototype.setZoomToExtent=function(layerId,padding){padding==null&&(padding=undefined);const layer=this.getLayer(layerId),extent=layer.getSource().getExtent();extent[0]!==Infinity&&this.Map.getView().fit(extent,{size:this.Map.getSize(),padding:padding})};MapOL.prototype.setCenter=function(point){this.Map.getView().setCenter(ol.proj.transform(point,this.Options.coordinatesProjection,this.Map.getView().getProjection()))};MapOL.prototype.setRotation=function(rotation){this.Map.getView().setRotation(rotation)};MapOL.prototype.setOptions=function(options){this.Options=options};MapOL.prototype.setInteractions=function(active){this.Map.getInteractions().forEach(interaction=>{interaction.setActive(active)});active?this.Map.getControls().getLength()==0&&this.addControls():this.Map.getControls().clear()};MapOL.prototype.addControls=function(){this.Options.zoomControl&&this.Map.addControl(new ol.control.Zoom);this.Options.attributionControl&&this.Map.addControl(new ol.control.Attribution);this.Options.fullScreenControl&&this.Map.addControl(new ol.control.FullScreen);this.Options.zoomSliderControl&&this.Map.addControl(new ol.control.ZoomSlider);this.Options.rotateControl&&this.Map.addControl(new ol.control.Rotate);this.Options.scaleLineUnit!="None"&&this.Map.addControl(new ol.control.ScaleLine({units:this.Options.scaleLineUnit.toLowerCase()}));this.Options.overviewMap&&this.Map.addControl(new ol.control.OverviewMap({layers:[new ol.layer.Tile(layers[0])]}));this.Options.zoomToExtentControl&&this.Map.addControl(new ol.control.ZoomToExtent)};MapOL.objectWithoutKey=function(object,key){const newObject={};for(let prop in object)prop!==key&&(newObject[prop]=object[prop]);return newObject};MapOL.prototype.getReducedFeature=function(feature){const type=feature.getGeometry().getType(),properties=MapOL.objectWithoutKey(feature.getProperties(),"geometry");return{type:"Feature",geometry:{type:feature.getGeometry().getType(),coordinates:feature.getGeometry().getCoordinates()},properties:properties}};MapOL.prototype.onMapClick=function(evt,popup){popup.setPosition(0,0);var that=this;const coordinate=ol.proj.transform(evt.coordinate,this.Map.getView().getProjection(),this.Options.coordinatesProjection);this.Instance.invokeMethodAsync("OnInternalClick",coordinate);this.Map.forEachFeatureAtPixel(evt.pixel,function(feature,layer){if(layer){const layerId=layer.get("id"),center=ol.extent.getCenter(feature.getGeometry().getExtent());if(ol.Feature.prototype.isPrototypeOf(feature)){const shape=that.mapFeatureToShape(feature);shape&&that.Instance.invokeMethodAsync("OnInternalShapeClick",shape,layerId);var showPopup=!1;shape&&(showPopup=shape.properties.popup);showPopup==undefined&&(showPopup=that.Options.autoPopup);showPopup&&popup.setPosition(center)}else if(ol.render.Feature.prototype.isPrototypeOf(feature)){const intFeature=that.mapFeatureToInternalFeature(feature);intFeature&&that.Instance.invokeMethodAsync("OnInternalFeatureClick",intFeature,layerId);that.Options.autoPopup&&popup.setPosition(center)}}})};MapOL.prototype.onMapDblClick=function(evt){const coordinate=ol.proj.transform(evt.coordinate,this.Map.getView().getProjection(),this.Options.coordinatesProjection);this.Instance.invokeMethodAsync("OnInternalDoubleClick",coordinate)};MapOL.prototype.showPopup=function(coordinates){this.OverlayPopup.setPosition(ol.proj.transform(coordinates,this.Options.coordinatesProjection,this.Map.getView().getProjection()))};MapOL.prototype.onMapPointerMove=function(evt){if(!evt.dragging&&!Number.isNaN(evt.coordinate[0])){const coordinate=ol.proj.transform(evt.coordinate,this.Map.getView().getProjection(),this.Options.coordinatesProjection);this.Instance.invokeMethodAsync("OnInternalPointerMove",coordinate);var hoverFeatureId=null,hoverLayerId=null;this.Map.forEachFeatureAtPixel(evt.pixel,function(feature,layer){if(layer){const featureId=feature.getId();if(featureId){const layerId=layer.get("id");hoverFeatureId||(hoverFeatureId=featureId.toString(),hoverLayerId=layerId)}}});(this._hoverFeatureId!=hoverFeatureId||this._hoverLayerId!=hoverLayerId)&&(this.Instance.invokeMethodAsync("OnInternalShapeHover",hoverLayerId,hoverFeatureId),this._hoverFeatureId=hoverFeatureId,this._hoverLayerId=hoverLayerId)}};MapOL.prototype.onMapResolutionChanged=function(){this.Instance.invokeMethodAsync("OnInternalZoomChanged",this.Map.getView().getZoom());this.onVisibleExtentChanged()};MapOL.prototype.onMapCenterChanged=function(){const center=this.Map.getView().getCenter();if(center){const coordinate=ol.proj.transform(center,this.Map.getView().getProjection(),this.Options.coordinatesProjection);this.Instance.invokeMethodAsync("OnInternalCenterChanged",coordinate);this.onVisibleExtentChanged()}};MapOL.prototype.onMapRotationChanged=function(){const rotation=this.Map.getView().getRotation();rotation&&this.Instance.invokeMethodAsync("OnInternalRotationChanged",rotation)};MapOL.prototype.onVisibleExtentChanged=function(){if(!this.disableVisibleExtentChanged){const extentArray=this.Map.getView().calculateExtent(this.Map.getSize()),coordinate1=ol.proj.transform([extentArray[0],extentArray[1]],this.Map.getView().getProjection(),this.Options.coordinatesProjection),coordinate2=ol.proj.transform([extentArray[2],extentArray[3]],this.Map.getView().getProjection(),this.Options.coordinatesProjection),extent={X1:coordinate1[0],Y1:coordinate1[1],X2:coordinate2[0],Y2:coordinate2[1]};this.Instance.invokeMethodAsync("OnInternalVisibleExtentChanged",extent)}};MapOL.prototype.centerToCurrentGeoLocation=function(){var that=this;navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(position){const projection=that.Map.getView().getProjection().getCode();that.Map.getView().setCenter(ol.proj.transform([position.coords.longitude,position.coords.latitude],"EPSG:4326",projection))})};MapOL.prototype.getCurrentGeoLocation=function(){var that=this;return new Promise((resolve,reject)=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(function(position){const projection=that.Map.getView().getProjection().getCode(),coordinate=ol.proj.transform([position.coords.longitude,position.coords.latitude],"EPSG:4326",projection);resolve(coordinate)}):reject("No geolocation received")})};MapOL.prototype.disableVisibleExtentChranged=!1;MapOL.prototype.setVisibleExtent=function(extent){this.disableVisibleExtentChanged=!0;const viewProjection=this.Map.getView().getProjection(),te=ol.proj.transformExtent([extent.x1,extent.y1,extent.x2,extent.y2],this.Options.coordinatesProjection,viewProjection);this.Map.getView().fit(te,this.Map.getSize());this.disableVisibleExtentChanged=!1};MapOL.prototype.currentDraw=null;MapOL.prototype.currentSnap=null;MapOL.prototype.currentModify=null;MapOL.prototype.setDrawingSettings=function(drawingLayerId,enableNewShapes,enableEditShapes,enableShapeSnap,geometryType,freehand){var that=this;this.removeDrawingInteractions();const source=this.getLayer(drawingLayerId).getSource();if(enableEditShapes&&this.currentModify==null&&(this.currentModify=new ol.interaction.Modify({source:source}),this.Map.addInteraction(this.currentModify)),enableNewShapes){this.currentDraw=new ol.interaction.Draw({source:source,type:geometryType,freehand:freehand});this.currentDraw.on("drawend",function(evt){that.getShapeStyleAsync(evt.feature,"geometries").then(style=>evt.feature.setStyle(style));that.onFeatureAdded(drawingLayerId,evt.feature)});this.Map.addInteraction(this.currentDraw)}enableShapeSnap&&(this.currentSnap=new ol.interaction.Snap({source:source}),this.Map.addInteraction(this.currentSnap))};MapOL.prototype.removeDrawingInteractions=function(){this.currentDraw&&(this.Map.removeInteraction(this.currentDraw),this.currentDraw=null);this.currentSnap&&(this.Map.removeInteraction(this.currentSnap),this.currentSnap=null);this.currentModify&&(this.Map.removeInteraction(this.currentModify),this.currentModify=null)};MapOL.prototype.undoDrawing=function(){this.currentDraw&&this.currentDraw.removeLastPoint()};MapOL.prototype.currentSelection=null;MapOL.prototype.setSelectionSettings=function(layerId,enableSelection,style,multiSelect){var that=this,defaultSelectionStyle=new ol.style.Style({fill:new ol.style.Fill({color:"#eeeeeeaa"}),stroke:new ol.style.Stroke({color:"rgba(67, 141, 239, 0.7)",width:5})});if(enableSelection){this.currentSelection=new ol.interaction.Select({condition:ol.events.condition.click,style:function(feature){if(style)return that.mapStyleOptionsToStyle(style);const color=feature.get("COLOR")||"#eeeeeeaa";return defaultSelectionStyle.getFill().setColor(color),defaultSelectionStyle},layers:layerId?[this.getLayer(layerId)]:undefined,multi:multiSelect});this.currentSelection.on("select",function(e){var selected=[],unselected;e.selected&&e.selected.forEach(f=>selected.push(that.mapFeatureToShape(f)));unselected=[];e.unselected&&e.unselected.forEach(f=>unselected.push(that.mapFeatureToShape(f)));that.Instance.invokeMethodAsync("OnInternalSelectionChanged",layerId,selected,unselected)});this.Map.addInteraction(this.currentSelection)}else this.currentSelection&&(this.Map.removeInteraction(this.currentSelection),this.currentSelection=null)};MapOL.prototype.mapFeatureToShape=function(feature){var gc,l,style,styleOptions,id,properties,shape;if(feature==null)return null;var geometry=feature.getGeometry(),viewProjection=this.Map?this.Map.getView().getProjection():this.Options.viewProjection?this.Options.viewProjection:"EPSG:3857",coordinates=null;if(geometry!=null&&!Array.isArray(geometry))switch(geometry.getType()){case"Circle":coordinates=ol.proj.transform(geometry.getCenter(),viewProjection,this.Options.coordinatesProjection);break;default:gc=geometry.getCoordinates();l=gc.length;Array.isArray(gc[0])&&gc.forEach(g2=>l=l+g2.length);l<this.Options.serializationCoordinatesLimit&&(coordinates=MapOL.transformCoordinates(gc,viewProjection,this.Options.coordinatesProjection))}return style=feature.getStyle(),typeof style=="function"&&(style=style(feature,this.Map.getView().getResolution())),styleOptions=[],Array.isArray(style)?style.forEach(s=>styleOptions.push(this.mapStylesToStyleOptions(s))):style&&(styleOptions=[this.mapStylesToStyleOptions(style)]),id=feature.getId(),id==null?(id=self.crypto.randomUUID(),feature.setId(id)):id=id.toString(),properties=MapOL.objectWithoutKey(feature.getProperties(),"geometry"),properties.type||(properties.type="Shape"),shape={id:id,geometryType:geometry?geometry.getType():"None",coordinates:coordinates,properties:properties,styles:styleOptions},geometry&&geometry.getType()=="Circle"&&geometry.getRadius&&(shape.radius=geometry.getRadius()),shape};MapOL.prototype.mapFeatureToInternalFeature=function(feature){var id,properties;if(feature==null)return null;var viewProjection=this.Map?this.Map.getView().getProjection():this.Options.viewProjection?this.Options.viewProjection:"EPSG:3857",coordinates=null,c=feature.getFlatCoordinates(),l=c.length;return Array.isArray(c[0])&&c.forEach(g2=>l=l+g2.length),l<this.Options.serializationCoordinatesLimit&&(coordinates=MapOL.transformCoordinates(c,viewProjection,this.Options.coordinatesProjection)),id=feature.getId()?feature.getId():feature.getProperties().feature_id,properties=feature.getProperties(),properties.type=feature.getType(),{id:id?id.toString():null,coordinates:coordinates,properties:properties}};MapOL.prototype.mapShapeToFeature=function(shape,source=null,transformCoordinates=true){var geometry,styles;const viewProjection=this.Map.getView().getProjection(),sourceProjection=source?source.getProjection():null;if(shape.coordinates){const coordinates=transformCoordinates?MapOL.transformCoordinates(shape.coordinates,sourceProjection?sourceProjection:this.Options.coordinatesProjection,viewProjection):shape.coordinates;switch(shape.geometryType){case"Point":geometry=new ol.geom.Point(coordinates);break;case"LineString":geometry=new ol.geom.LineString(coordinates);break;case"Polygon":geometry=new ol.geom.Polygon(coordinates);break;case"Circle":geometry=new ol.geom.Circle(coordinates,shape.radius/ol.proj.getPointResolution(viewProjection,1,coordinates));break;case"MultiPoint":geometry=new ol.geom.MultiPoint(coordinates);break;case"MultiLineString":geometry=new ol.geom.MultiLineString(coordinates);break;case"MultiPolygon":geometry=new ol.geom.MultiPolygon(coordinates)}}const feature=new ol.Feature({type:shape.properties.type,popup:shape.properties.popup,markerstyle:shape.properties.markerstyle});return feature.setId(shape.id),geometry&&feature.setGeometry(geometry),shape.styles&&(Array.isArray(shape.styles)?(styles=[],shape.styles.forEach(s=>styles.push(this.mapStyleOptionsToStyle(s))),feature.setStyle(styles)):feature.setStyle(this.mapStyleOptionsToStyle(shape.styles))),shape.flatStyle&&feature.setStyle(shape.flatStyle),feature};MapOL.prototype.onFeatureAdded=function(layerId,feature){const shape=this.mapFeatureToShape(feature);this.Instance.invokeMethodAsync("OnInternalShapeAdded",layerId,shape)};MapOL.prototype.onFeatureRemoved=function(layerId,feature){const shape=this.mapFeatureToShape(feature);this.Instance.invokeMethodAsync("OnInternalShapeRemoved",layerId,shape)};MapOL.prototype.onFeatureChanged=function(layerId,feature){const shape=this.mapFeatureToShape(feature);this.Instance.invokeMethodAsync("OnInternalShapeChanged",layerId,shape)};MapOL.prototype.updateShape=function(layerId,shape){const layer=this.getLayer(layerId),feature=layer.getSource().getFeatureById(shape.id);if(feature){const newFeature=this.mapShapeToFeature(shape),geometry=newFeature.getGeometry();geometry&&feature.setGeometry(geometry);feature.setStyle(newFeature.getStyle())}};MapOL.prototype.setShapes=function(layerId,shapes){var source=this.getLayer(layerId).getSource();ol.source.Cluster.prototype.isPrototypeOf(source)&&(source=source.source);source.clear();shapes&&shapes.forEach(shape=>{var feature=this.mapShapeToFeature(shape,source);source.addFeature(feature)})};MapOL.prototype.removeShapes=function(layerId,shapes){shapes.forEach(shape=>{const layer=this.Map.getAllLayers().find(l=>l.get("id")==layerId),source=layer.getSource(),feature=source.getFeatureById(shape.id);feature&&source.removeFeature(feature)})};MapOL.prototype.addShapes=function(layerId,shapes){shapes.forEach(shape=>{const layer=this.Map.getAllLayers().find(l=>l.get("id")==layerId),source=layer.getSource(),feature=this.mapShapeToFeature(shape,source);source.addFeature(feature)})};MapOL.prototype.getCoordinates=function(layerId,featureId){const feature=this.getLayer(layerId).getSource().getFeatureById(featureId);if(feature){let coord=feature.getGeometry().getCoordinates();return coord||(coord=feature.getGeometry().getCenter()),coord}return null};MapOL.prototype.setCoordinates=function(layerId,featureId,coordinates){const feature=this.getLayer(layerId).getSource().getFeatureById(featureId);if(feature!=null){const geometry=feature.getGeometry(),viewProjection=this.Map.getView().getProjection(),sourceProjection=this.getLayer(layerId).getSource().getProjection(),coordinatesTransformed=MapOL.transformCoordinates(coordinates,sourceProjection?sourceProjection:this.Options.coordinatesProjection,viewProjection);geometry.getType()=="Circle"?geometry.setCenter(coordinatesTransformed):geometry.setCoordinates(coordinatesTransformed)}};MapOL.prototype.getShapeStyleAsync=async function(feature,layer_id){var shape;shape=ol.render.Feature.prototype.isPrototypeOf(feature)?this.mapFeatureToInternalFeature(feature):this.mapFeatureToShape(feature);delete shape.coordinates;const style=await this.Instance.invokeMethodAsync("OnGetShapeStyleAsync",shape,layer_id);return this.mapStyleOptionsToStyle(style,shape.geometryType)};MapOL.prototype.getShapeStyle=function(feature,layer_id){var shape;shape=ol.render.Feature.prototype.isPrototypeOf(feature)?this.mapFeatureToInternalFeature(feature):this.mapFeatureToShape(feature);delete shape.coordinates;const style=this.Instance.invokeMethod("OnGetShapeStyle",shape,layer_id);return this.mapStyleOptionsToStyle(style,shape.geometryType)};MapOL.prototype.mapStyleOptionsToStyle=function(style,geometryType=null){if(style=MapOL.transformNullToUndefined(style),style.icon&&style.icon.shapeSource){const canvas=document.createElement("canvas"),context=ol.render.toContext(canvas.getContext("2d"),{size:style.icon.size,pixelRatio:1}),feature=this.mapShapeToFeature(style.icon.shapeSource,null,!1);context.setStyle(feature.getStyle()[0]);context.drawGeometry(feature.getGeometry());style.icon.img=canvas}style.icon&&style.icon.scale&&(style.icon.width=undefined,style.icon.height=undefined);style.circle&&(style.circle.fill&&(style.circle.fill=new ol.style.Fill(style.circle.fill)),style.circle.stroke&&(style.circle.stroke=new ol.style.Stroke(style.circle.stroke)));style.text&&(style.text.fill&&(style.text.fill=new ol.style.Fill(style.text.fill)),style.text.stroke&&(style.text.stroke=new ol.style.Stroke(style.text.stroke)),style.text.backgroundFill&&(style.text.backgroundFill=new ol.style.Fill(style.text.backgroundFill)),style.text.backgroundStroke&&(style.text.backgroundStroke=new ol.style.Stroke(style.text.backgroundStroke)));geometryType!="Point"||style.circle||(style.circle={fill:new ol.style.Fill(style.fill),stroke:new ol.style.Stroke(style.stroke),radius:style.stroke.width*2});const styleObject=new ol.style.Style({stroke:style.stroke?new ol.style.Stroke(style.stroke):undefined,fill:style.fill?new ol.style.Fill(style.fill):undefined,text:style.text?new ol.style.Text(style.text):undefined,image:style.circle?new ol.style.Circle(style.circle):style.icon?new ol.style.Icon(style.icon):undefined,zIndex:style.zIndex});return style.circle&&styleObject.getImage().setOpacity(style.circle.opacity),styleObject};MapOL.prototype.mapStylesToStyleOptions=function(style){var image=style.getImage(),fill=style.getFill(),stroke=style.getStroke(),text=style.getText(),icon,circle;return image&&image.getSrc&&(icon=image),image&&image.getRadius&&(circle=image),{fill:fill?{color:fill.getColor()}:undefined,stroke:stroke?{color:stroke.getColor(),lineCap:stroke.getLineCap(),lineJoin:stroke.getLineJoin(),lineDash:stroke.getLineDash(),lineDashOffset:stroke.getLineDashOffset(),miterLimit:stroke.getMiterLimit(),width:stroke.getWidth()}:undefined,text:text?{font:text.getFont(),maxAngle:text.getMaxAngle(),offsetX:text.getOffsetX(),offsetY:text.getOffsetY(),overflow:text.getOverflow(),placement:text.getPlacement(),repeat:text.getRepeat(),scale:text.getScale(),rotateWithView:text.getRotateWithView(),rotation:text.getRotation(),text:text.getText(),textAlign:text.getTextAlign(),justify:text.getJustify(),textBaseline:text.getTextBaseline(),fill:text.getFill()?{color:text.getFill().getColor()}:undefined,backgroundFill:text.getBackgroundFill()?{color:text.getBackgroundFill().getColor()}:undefined,stroke:text.getStroke()?{color:text.getStroke().getColor(),lineCap:text.getStroke().getLineCap(),lineJoin:text.getStroke().getLineJoin(),lineDash:text.getStroke().getLineDash(),lineDashOffset:text.getStroke().getLineDashOffset(),miterLimit:text.getStroke().getMiterLimit(),width:text.getStroke().getWidth()}:undefined,backgroundStroke:text.getBackgroundStroke()?{color:text.getBackgroundStroke().getColor(),lineCap:text.getBackgroundStroke().getLineCap(),lineJoin:text.getBackgroundStroke().getLineJoin(),lineDash:text.getBackgroundStroke().getLineDash(),lineDashOffset:text.getBackgroundStroke().getLineDashOffset(),miterLimit:text.getBackgroundStroke().getMiterLimit(),width:text.getBackgroundStroke().getWidth()}:undefined,padding:text.getPadding()}:undefined,circle:circle?{radius:circle.getRadius(),fill:circle.fill?{color:circle.fill.getColor()}:undefined,rotation:circle.getRotation(),rotateWithView:circle.getRotateWithView(),declutterMode:circle.getDeclutterMode(),displacement:circle.getDisplacement(),stroke:circle.stroke?{color:circle.stroke.getColor(),lineCap:circle.stroke.getLineCap(),lineJoin:circle.stroke.getLineJoin(),lineDash:circle.stroke.getLineDash(),lineDashOffset:circle.stroke.getLineDashOffset(),miterLimit:circle.stroke.getMiterLimit(),width:circle.stroke.getWidth()}:undefined}:undefined,icon:icon?{anchor:icon.getAnchor(),color:icon.getColor(),declutterMode:icon.getDeclutterMode(),height:icon.getHeight(),opacity:icon.getOpacity(),rotation:icon.getRotation(),rotateWithView:icon.getRotateWithView(),scale:icon.getScale(),size:icon.getSize(),width:icon.getWidth(),src:icon.getSrc()}:undefined,zIndex:style.getZIndex()}};MapOL.prototype.applyMapboxStyle=function(styleUrl,accessToken){var that=this;this.Map.getAllLayers().forEach(l=>{that.Map.removeLayer(l)});olms.apply(this.Map,styleUrl,{accessToken:accessToken}).then(function(){})};MapOL.transformNullToUndefined=function transformNullToUndefined(obj){for(const key in obj)obj.hasOwnProperty(key)&&obj[key]===null?obj[key]=undefined:typeof obj[key]=="object"&&transformNullToUndefined(obj[key]);return obj};MapOL.transformCoordinates=function(coordinates,source,destination){var newCoordinates;if(source===destination)return coordinates;if(Array.isArray(coordinates)&&Array.isArray(coordinates[0])){newCoordinates=Array(coordinates.length);for(let i=0;i<coordinates.length;i++)if(Array.isArray(coordinates[i][0])){newCoordinates[i]=Array(coordinates[i].length);for(let i2=0;i2<coordinates[i].length;i2++)newCoordinates[i][i2]=ol.proj.transform(coordinates[i][i2],source,destination)}else newCoordinates[i]=ol.proj.transform(coordinates[i],source,destination)}else newCoordinates=ol.proj.transform(coordinates,source,destination);return newCoordinates};MapOL.WGStoLV03y=function(lat,lng){lat=DECtoSEX(lat);lng=DECtoSEX(lng);lat=DEGtoSEC(lat);lng=DEGtoSEC(lng);const lat_aux=(lat-169028.66)/1e4,lng_aux=(lng-26782.5)/1e4;return 600072.37+211455.93*lng_aux-10938.51*lng_aux*lat_aux-.36*lng_aux*Math.pow(lat_aux,2)-44.54*Math.pow(lng_aux,3)};MapOL.WGStoLV03x=function(lat,lng){lat=DECtoSEX(lat);lng=DECtoSEX(lng);lat=DEGtoSEC(lat);lng=DEGtoSEC(lng);const lat_aux=(lat-169028.66)/1e4,lng_aux=(lng-26782.5)/1e4;return 200147.07+308807.95*lat_aux+3745.25*Math.pow(lng_aux,2)+76.63*Math.pow(lat_aux,2)-194.56*Math.pow(lng_aux,2)*lat_aux+119.79*Math.pow(lat_aux,3)};MapOL.CHtoLV03lat=function(y,x){const y_aux=(y-6e5)/1e6,x_aux=(x-2e5)/1e6;let lat=16.902389199999998+3.238272*x_aux-.270978*Math.pow(y_aux,2)-.002528*Math.pow(x_aux,2)-.0447*Math.pow(y_aux,2)*x_aux-.014*Math.pow(x_aux,3);return lat*100/36};MapOL.CHtoLV03lng=function(y,x){const y_aux=(y-6e5)/1e6,x_aux=(x-2e5)/1e6;let lng=2.6779094+4.728982*y_aux+.791484*y_aux*x_aux+.1306*y_aux*Math.pow(x_aux,2)-.0436*Math.pow(y_aux,3);return lng*100/36};MapOL.DECtoSEX=function(angle){const deg=parseInt(angle,10),min=parseInt((angle-deg)*60,10),sec=((angle-deg)*60-min)*60;return deg+min/100+sec/1e4};MapOL.DEGtoSEC=function(angle){const deg=parseInt(angle,10);let min=parseInt((angle-deg)*100,10),sec=((angle-deg)*100-min)*100;const parts=String(angle).split(".");return parts.length==2&&parts[1].length==2&&(min=Number(parts[1]),sec=0),sec+min*60+deg*3600};MapOL.WGStoLV95y=function(lat,lng){const phi=(lat*3600-169028.66)/1e4,phi2=phi*phi,lambda=(lng*3600-26782.5)/1e4,lambda2=lambda*lambda,lambda3=lambda2*lambda;return 2600072.37+211455.93*lambda-10938.51*lambda*phi-.36*lambda*phi2-44.54*lambda3};MapOL.WGStoLV95x=function(lat,lng){const phi=(lat*3600-169028.66)/1e4,phi2=phi*phi,phi3=phi2*phi,lambda=(lng*3600-26782.5)/1e4,lambda2=lambda*lambda;return 1200147.07+308807.95*phi+3745.25*lambda2+76.63*phi2-194.56*lambda2*phi+119.79*phi3};MapOL.LV95toWGSlat=function(y,x){const x1=(x-12e5)/1e6,x2=x1*x1,x3=x2*x1,y1=(y-26e5)/1e6,y2=y1*y1,latitude=16.902389199999998+3.238272*x1-.270978*y2-.002528*x2-.0447*y2*x1-.014*x3;return latitude*100/36};MapOL.LV95toWGSlng=function(y,x){const x1=(x-12e5)/1e6,x2=x1*x1,y1=(y-26e5)/1e6,y2=y1*y1,y3=y2*y1,longitude=2.6779094+4.728982*y1+.791484*y1*x1+.1306*y1*x2-.0436*y3;return longitude*100/36};